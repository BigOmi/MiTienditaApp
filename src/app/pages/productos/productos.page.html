<ion-content [fullscreen]="true" class="productos-content">
  <ion-grid class="ion-padding">

    <!-- Filtros -->
    <ion-row class="ion-align-items-center filtros-row" no-wrap>
      <ion-col size="12" size-md="5">
        <ion-searchbar
          [(ngModel)]="buscarproduct"
          debounce="300"
          placeholder="Buscar producto..."
          class="searchbar-custom"
        ></ion-searchbar>
      </ion-col>

      <ion-col size="6" size-md="2">
        <ion-select
          interface="popover"
          [(ngModel)]="estadoFiltro"
          placeholder="Estado"
          ok-text="Seleccionar"
          cancel-text="Cancelar"
          class="select-filtro"
        >
          <ion-select-option value="todos">Todos</ion-select-option>
          <ion-select-option value="activos">Activos</ion-select-option>
          <ion-select-option value="inactivos">Inactivos</ion-select-option>
        </ion-select>
      </ion-col>

      <ion-col size="6" size-md="3">
        <ion-select
          interface="popover"
          [(ngModel)]="categoriaSeleccionada"
          placeholder="Categoría"
          ok-text="Seleccionar"
          cancel-text="Cancelar"
          class="select-filtro"
        >
          <ion-select-option value="Todos">Todos</ion-select-option>
          <ion-select-option *ngFor="let cat of categorias" [value]="cat.id">
            {{ cat.nombre }}
          </ion-select-option>
        </ion-select>
      </ion-col>

      <ion-col size="12" size-md="2" class="ion-text-end">
        <ion-button (click)="navNewProduct()" expand="block" color="success" fill="solid" size="small">
          <ion-icon slot="start" name="add-circle-outline"></ion-icon>
          Agregar
        </ion-button>
      </ion-col>
    </ion-row>

    <!-- Lista de productos con formulario de edición individual -->
    <ion-row class="ion-margin-top">
      <ion-col size="12" *ngFor="let producto of productosFiltrados">
        <ion-card class="producto-mini-card" [class.inactivo]="!producto.activo" [id]="'producto-' + producto.id">
          <ion-row class="ion-align-items-center">
            <ion-col size="3" class="img-mini-col">
              <img [src]="producto.imagen" [alt]="producto.nombre" class="img-mini" />
            </ion-col>

            <ion-col size="6" class="info-mini-col">
              <h3 class="producto-nombre">{{ producto.nombre }}</h3>
              <p class="producto-precio"> <span class="venta">${{ producto.precioVenta }}</span> </p>
              <p class="producto-stock">Stock: {{ producto.stock }}</p>
              <p class="producto-estado" [class.activo]="producto.activo" [class.inactivo]="!producto.activo">
                {{ producto.activo ? 'Activo' : 'Inactivo' }}
              </p>
            </ion-col>

            <ion-col size="3" class="acciones-mini-col">
              <ion-button fill="clear" color="tertiary" size="small" (click)="editarProducto(producto)">
                <ion-icon name="create-outline" slot="icon-only"></ion-icon>
              </ion-button>
              <ion-button fill="clear" color="danger" size="small" (click)="eliminarProducto(producto.id)">
                <ion-icon name="trash-outline" slot="icon-only"></ion-icon>
              </ion-button>
            </ion-col>
          </ion-row>

          <!-- Formulario de edición debajo del producto -->
          <ion-row *ngIf="productoEditandoId === producto.id">
            <ion-col size="12">
              <ion-card>
                <ion-card-header>
                  <ion-card-title>Editar Producto</ion-card-title>
                </ion-card-header>

                <ion-card-content>
                  <form [formGroup]="editForm" (ngSubmit)="guardarCambios()">
                    <ion-item>
                      <ion-label position="floating">Nombre</ion-label>
                      <ion-input formControlName="nombre"></ion-input>
                    </ion-item>

                    <ion-item>
                      <ion-label position="floating">Descripción</ion-label>
                      <ion-input formControlName="descripcion"></ion-input>
                    </ion-item>

                    <ion-item>
                      <ion-label position="floating">Imagen</ion-label>
                      <ion-input formControlName="imagen"></ion-input>
                    </ion-item>

                    <ion-item>
                      <ion-label position="floating">Precio Compra</ion-label>
                      <ion-input type="number" formControlName="precioCompra"></ion-input>
                    </ion-item>

                    <ion-item>
                      <ion-label position="floating">Precio Venta</ion-label>
                      <ion-input type="number" formControlName="precioVenta"></ion-input>
                    </ion-item>

                    <ion-item>
                      <ion-label position="floating">Stock</ion-label>
                      <ion-input type="number" formControlName="stock"></ion-input>
                    </ion-item>

                    <ion-item>
                      <ion-label>Categoría</ion-label>
                      <ion-select formControlName="categoria">
                        <ion-select-option *ngFor="let cat of categorias" [value]="cat.id">
                          {{ cat.nombre }}
                        </ion-select-option>
                      </ion-select>
                    </ion-item>

                    <ion-item>
                      <ion-label>Estado</ion-label>
                      <ion-toggle slot="end" formControlName="activo"></ion-toggle>
                    </ion-item>

                    <ion-button expand="block" type="submit" [disabled]="editForm.invalid">Guardar</ion-button>
                    <ion-button expand="block" color="medium" (click)="cancelarEdicion()">Cancelar</ion-button>
                  </form>
                </ion-card-content>
              </ion-card>
            </ion-col>
          </ion-row>

        </ion-card>
      </ion-col>
    </ion-row>
  </ion-grid>
</ion-content>
