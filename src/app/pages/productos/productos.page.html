<ion-content [fullscreen]="true" class="productos-content">
  <ion-grid class="ion-padding">

    <!-- Filtros -->
    <ion-row class="ion-align-items-center filtros-row" no-wrap>
      <ion-col size="12" size-md="5">
        <ion-searchbar
          [(ngModel)]="buscarproduct"
          debounce="300"
          placeholder="Buscar producto..."
          class="searchbar-custom"
        ></ion-searchbar>
      </ion-col>

      <ion-col size="6" size-md="2">
        <ion-select
          interface="popover"
          [(ngModel)]="estadoFiltro"
          placeholder="Estado"
          ok-text="Seleccionar"
          cancel-text="Cancelar"
          class="select-filtro"
        >
          <ion-select-option value="todos">Todos</ion-select-option>
          <ion-select-option value="activos">Activos</ion-select-option>
          <ion-select-option value="inactivos">Inactivos</ion-select-option>
        </ion-select>
      </ion-col>

      <ion-col size="6" size-md="3">
        <ion-select
          interface="popover"
          [(ngModel)]="categoriaSeleccionada"
          placeholder="Categoría"
          ok-text="Seleccionar"
          cancel-text="Cancelar"
          class="select-filtro"
        >
          <ion-select-option value="Todos">Todos</ion-select-option>
          <ion-select-option *ngFor="let cat of categorias" [value]="cat.id">
            {{ cat.nombre }}
          </ion-select-option>
        </ion-select>
      </ion-col>

      <ion-col size="12" size-md="2" class="ion-text-end">
        <ion-button (click)="navNewCompra()" expand="block" color="success" fill="solid" size="small">
          <ion-icon slot="end" name="add-circle-outline"></ion-icon>
          Comprar Producto
        </ion-button>
      </ion-col>
    </ion-row>

    <!-- Lista de productos -->
    <ion-row class="ion-margin-top">
      <ion-col size="12" *ngFor="let producto of productosFiltrados">
        <ion-card class="producto-mini-card card-elevated" [class.inactivo]="!producto.activo" [id]="'producto-' + producto.id">
          <ion-item lines="none">
            <ion-thumbnail slot="start" class="thumb-mini">
              <img [src]="producto.imagen" [alt]="producto.nombre" />
            </ion-thumbnail>
            <ion-label>
              <h3 class="producto-nombre">{{ producto.nombre }}</h3>
              <div class="badges-row">
                <ion-chip color="success" class="chip-compact">
                  <ion-icon name="cash-outline"></ion-icon>
                  <ion-label>${{ producto.precioVenta }}</ion-label>
                </ion-chip>
                <ion-chip color="medium" class="chip-compact">
                  <ion-icon name="cube-outline"></ion-icon>
                  <ion-label>Stock: {{ producto.stock }}</ion-label>
                </ion-chip>
                <ion-chip [color]="producto.activo ? 'success' : 'medium'" class="chip-compact">
                  <ion-icon [name]="producto.activo ? 'checkmark-circle-outline' : 'close-circle-outline'"></ion-icon>
                  <ion-label>{{ producto.activo ? 'Activo' : 'Inactivo' }}</ion-label>
                </ion-chip>
              </div>
            </ion-label>
            <ion-buttons slot="end" class="acciones-mini-col">
              <ion-button fill="clear" color="tertiary" size="small" (click)="editarProducto(producto)">
                <ion-icon name="create-outline" slot="icon-only"></ion-icon>
              </ion-button>
              <ion-button fill="clear" color="danger" size="small" (click)="eliminarProducto(producto.id)">
                <ion-icon name="trash-outline" slot="icon-only"></ion-icon>
              </ion-button>
            </ion-buttons>
          </ion-item>

          <!-- Formulario de edición -->
          <ion-row *ngIf="productoEditandoId === producto.id">
            <ion-col size="12">
              <ion-card class="card-elevated">
                <ion-card-header>
                  <ion-card-title>Editar Producto</ion-card-title>
                </ion-card-header>

                <ion-card-content>
                  <form [formGroup]="editForm" (ngSubmit)="guardarCambios()">
                    <ion-item>
                      <ion-label position="floating">Nombre</ion-label>
                      <ion-input formControlName="nombre"></ion-input>
                    </ion-item>

                    <ion-item>
                      <ion-label position="floating">Descripción</ion-label>
                      <ion-input formControlName="descripcion"></ion-input>
                    </ion-item>

                    <ion-item>
                      <ion-label position="floating">Imagen</ion-label>
                      <ion-input formControlName="imagen"></ion-input>
                    </ion-item>

                    <ion-item>
                      <ion-label position="floating">Precio Compra</ion-label>
                      <ion-input type="number" formControlName="precioCompra" readonly></ion-input>
                    </ion-item>

                    <ion-item>
                      <ion-label position="floating">Precio Venta</ion-label>
                      <ion-input type="number" formControlName="precioVenta"></ion-input>
                    </ion-item>

                    <ion-item>
                      <ion-label position="floating">Stock</ion-label>
                      <ion-input type="number" formControlName="stock" readonly></ion-input>
                    </ion-item>

                    <ion-item>
                      <ion-label>Categoría</ion-label>
                      <ion-select formControlName="categoria">
                        <ion-select-option *ngFor="let cat of categorias" [value]="cat.id">
                          {{ cat.nombre }}
                        </ion-select-option>
                      </ion-select>
                    </ion-item>

                    <ion-item>
                      <ion-label>Estado</ion-label>
                      <ion-toggle slot="end" formControlName="activo"></ion-toggle>
                    </ion-item>

                    <ion-button expand="block" type="submit" [disabled]="editForm.invalid">Guardar</ion-button>
                    <ion-button expand="block" color="medium" (click)="cancelarEdicion()">Cancelar</ion-button>
                  </form>
                </ion-card-content>
              </ion-card>
            </ion-col>
          </ion-row>

        </ion-card>
      </ion-col>
    </ion-row>
  </ion-grid>
</ion-content>
