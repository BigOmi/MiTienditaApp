<ion-content [fullscreen]="true" class="ventas-content" (click)="onContentClick()">
  <div class="contenedor-principal">
    <!-- Filtros -->
    <div class="filtros">
      <ion-searchbar
        [(ngModel)]="busqueda"
        placeholder="Buscar ventas..."
        debounce="300"
        (ionInput)="filtrarVentas()"
        class="buscador"
      ></ion-searchbar>

      <div class="filtro-fecha-con-calendario">
        <ion-select
          placeholder="Filtro fecha"
          interface="popover"
          [(ngModel)]="filtroFecha"
          (ionChange)="filtrarVentas()"
        >
          <ion-select-option value="ninguno">Ninguno</ion-select-option>
          <ion-select-option value="dia">Por Día</ion-select-option>
          <ion-select-option value="semana">Por Semana</ion-select-option>
          <ion-select-option value="mes">Por Mes</ion-select-option>
        </ion-select>

        <!-- Ícono + calendario + rango -->
        <div class="icono-calendario" (click)="$event.stopPropagation()">
          <ion-icon
            name="calendar-outline"
            class="calendario"
            (click)="toggleCalendar()"
          ></ion-icon>

          <ion-datetime
            *ngIf="showCalendar"
            [(ngModel)]="fechaSeleccionada"
            (ionChange)="onFechaChange($event)"
            presentation="date"
            class="datetime-inline"
          ></ion-datetime>
        </div>

        <div class="rango-fechas" *ngIf="filtroFecha==='ninguno'">
          <ion-input type="date" [(ngModel)]="desde" (ionChange)="filtrarVentas()" placeholder="Desde"></ion-input>
          <ion-input type="date" [(ngModel)]="hasta" (ionChange)="filtrarVentas()" placeholder="Hasta"></ion-input>
        </div>
      </div>

      <div class="acciones-derecha">
        <ion-button fill="outline" color="secondary" size="small" (click)="exportarCSV()">
          <ion-icon name="download-outline" slot="start"></ion-icon>
          Exportar CSV
        </ion-button>
      </div>
    </div>

    <!-- Mostrar semana seleccionada -->
    <div *ngIf="semanaSeleccionada" class="semana-rango">
      <strong>{{ semanaSeleccionada.inicio }}</strong> a
      <strong>{{ semanaSeleccionada.fin }}</strong>
    </div>

    <!-- Tabla -->
    <div class="tabla-card" *ngIf="!loading; else skeletonTabla">
      <table class="ventas-tabla">
        <thead>
          <tr>
            <th (click)="ordenarPor('id')">ID Venta</th>
            <th (click)="ordenarPor('cantidad')">Cant. Productos</th>
            <th (click)="ordenarPor('usuario')">Usuario</th>
            <th>
              <ion-select size="small" interface="popover" placeholder="Pago" (ionChange)="filtrarVentas()" [(ngModel)]="filtroPago">
                <ion-select-option value="">Todos</ion-select-option>
                <ion-select-option value="efectivo">Efectivo</ion-select-option>
                <ion-select-option value="tarjeta">Tarjeta</ion-select-option>
                <ion-select-option value="transferencia">Transferencia</ion-select-option>
              </ion-select>
            </th>
            <th (click)="ordenarPor('total')">Total</th>
            <th (click)="ordenarPor('fecha')">Fecha</th>
            <th (click)="ordenarPor('hora')">Hora</th>
            <th>
              <ion-select size="small" interface="popover" placeholder="Estado" (ionChange)="filtrarVentas()" [(ngModel)]="filtroStatus">
                <ion-select-option value="">Todos</ion-select-option>
                <ion-select-option value="pendiente">Pendiente</ion-select-option>
                <ion-select-option value="pagado">Pagado</ion-select-option>
                <ion-select-option value="cancelado">Cancelado</ion-select-option>
              </ion-select>
            </th>
            <th>Detalles</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let venta of ventasFiltradas; else estadoVacio">
            <td>{{ venta.id }}</td>
            <td>{{ venta.cantidad }}</td>
            <td>{{ venta.usuario }}</td>
            <td><span class="badge badge-info">{{ venta.metodoPago }}</span></td>
            <td>${{ venta.total.toFixed(2) }}</td>
            <td>{{ venta.fecha }}</td>
            <td>{{ venta.hora }}</td>
            <td>
              <span class="badge" [ngClass]="statusClass(venta.status)">{{ venta.status }}</span>
            </td>
            <td>
              <button (click)="verDetalles(venta)" class="ver-ticket">
                Ver ticket
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <ng-template #estadoVacio>
      <tr>
        <td colspan="9">
          <ion-item lines="none">
            <ion-icon name="clipboard-outline" slot="start"></ion-icon>
            <ion-label>No hay ventas para mostrar</ion-label>
          </ion-item>
        </td>
      </tr>
    </ng-template>

    <ng-template #skeletonTabla>
      <ion-card>
        <ion-card-content>
          <ion-skeleton-text animated style="width: 60%; height: 16px;"></ion-skeleton-text>
          <ion-skeleton-text animated style="width: 100%; height: 14px; margin-top:8px"></ion-skeleton-text>
          <ion-skeleton-text animated style="width: 100%; height: 14px; margin-top:8px"></ion-skeleton-text>
          <ion-skeleton-text animated style="width: 80%; height: 14px; margin-top:8px"></ion-skeleton-text>
        </ion-card-content>
      </ion-card>
    </ng-template>

    <!-- Total vendido -->
    <div class="total-vendido">
      <p>Total vendido</p>
      <strong>${{ totalVendido.toFixed(2) }}</strong>
    </div>

    <!-- Modal detalles -->
    <div class="modal" *ngIf="modalAbierto" (click)="cerrarModal()">
      <div
        class="modal-content"
        (click)="$event.stopPropagation()"
        role="dialog"
        aria-modal="true"
      >
        <h3>Detalles de venta #{{ detalleVenta.id }}</h3>
        <p><strong>Usuario:</strong> {{ detalleVenta.usuario }}</p>
        <p><strong>Fecha:</strong> {{ detalleVenta.fecha }} {{ detalleVenta.hora }}</p>
        <p><strong>Status:</strong> {{ detalleVenta.status }}</p>
        <p><strong>Método de pago:</strong> {{ detalleVenta.metodoPago }}</p>

        <table>
          <thead>
            <tr>
              <th>Producto</th>
              <th>Cantidad</th>
              <th>Precio</th>
              <th>Subtotal</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let p of detalleVenta.productos">
              <td>{{ p.nombre }}</td>
              <td>{{ p.cantidad }}</td>
              <td>${{ formatPrecio(p.precio) }}</td>
              <td>${{ formatPrecio(p.cantidad * p.precio) }}</td>
            </tr>

            <tr>
              <td colspan="3"><strong>Total</strong></td>
              <td><strong>${{ calcularTotal(detalleVenta.productos) | number:'1.2-2' }}</strong></td>
            </tr>
          </tbody>
        </table>

        <button (click)="cerrarModal()" class="btn-cerrar">Cerrar</button>
      </div>
    </div>
  </div>
</ion-content>
<ion-fab slot="fixed" vertical="bottom" horizontal="end">
  <ion-fab-button color="success" (click)="exportarCSV()" aria-label="Exportar ventas a CSV">
    <ion-icon name="download"></ion-icon>
  </ion-fab-button>
  <ion-fab-list side="top">
    <ion-fab-button color="primary" (click)="filtrarVentas()" aria-label="Refrescar lista">
      <ion-icon name="refresh"></ion-icon>
    </ion-fab-button>
  </ion-fab-list>
</ion-fab>
