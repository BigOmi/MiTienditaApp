<ion-content [fullscreen]="true" class="ventas-content" (click)="onContentClick()">
  <div class="contenedor-principal">
    <!-- Filtros -->
    <div class="filtros">
      <ion-searchbar
        [(ngModel)]="busqueda"
        placeholder="Buscar ventas..."
        debounce="300"
        (ionInput)="filtrarVentas()"
        class="buscador"
      ></ion-searchbar>

      <div class="filtro-fecha-con-calendario">
        <ion-select
          placeholder="Filtro fecha"
          interface="popover"
          [(ngModel)]="filtroFecha"
          (ionChange)="filtrarVentas()"
        >
          <ion-select-option value="ninguno">Ninguno</ion-select-option>
          <ion-select-option value="dia">Por Día</ion-select-option>
          <ion-select-option value="semana">Por Semana</ion-select-option>
          <ion-select-option value="mes">Por Mes</ion-select-option>
        </ion-select>

        <!-- Ícono + calendario -->
        <div class="icono-calendario" (click)="$event.stopPropagation()">
          <ion-icon
            name="calendar-outline"
            class="calendario"
            (click)="toggleCalendar()"
          ></ion-icon>

          <ion-datetime
            *ngIf="showCalendar"
            [(ngModel)]="fechaSeleccionada"
            (ionChange)="onFechaChange($event)"
            presentation="date"
            class="datetime-inline"
          ></ion-datetime>
        </div>
      </div>
    </div>

    <!-- Mostrar semana seleccionada -->
    <div *ngIf="semanaSeleccionada" class="semana-rango">
      <strong>{{ semanaSeleccionada.inicio }}</strong> a
      <strong>{{ semanaSeleccionada.fin }}</strong>
    </div>

    <!-- Tabla -->
    <div class="tabla-card">
      <table class="ventas-tabla">
        <thead>
          <tr>
            <th>ID Venta</th>
            <th>Cant. Productos</th>
            <th>Usuario</th>
            <th>Pago</th>
            <th>Total</th>
            <th>Fecha</th>
            <th>Hora</th>
            <th>Status</th>
            <th>Detalles</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let venta of ventasFiltradas">
            <td>{{ venta.id }}</td>
            <td>{{ venta.cantidad }}</td>
            <td>{{ venta.usuario }}</td>
            <td>{{ venta.metodoPago }}</td>
            <td>${{ venta.total.toFixed(2) }}</td>
            <td>{{ venta.fecha }}</td>
            <td>{{ venta.hora }}</td>
            <td>{{ venta.status }}</td>
            <td>
              <button (click)="verDetalles(venta)" class="ver-ticket">
                Ver ticket
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Total vendido -->
    <div class="total-vendido">
      <p>Total vendido</p>
      <strong>${{ totalVendido.toFixed(2) }}</strong>
    </div>

    <!-- Modal detalles -->
    <div class="modal" *ngIf="modalAbierto" (click)="cerrarModal()">
      <div
        class="modal-content"
        (click)="$event.stopPropagation()"
        role="dialog"
        aria-modal="true"
      >
        <h3>Detalles de venta #{{ detalleVenta.id }}</h3>
        <p><strong>Usuario:</strong> {{ detalleVenta.usuario }}</p>
        <p><strong>Fecha:</strong> {{ detalleVenta.fecha }} {{ detalleVenta.hora }}</p>
        <p><strong>Status:</strong> {{ detalleVenta.status }}</p>
        <p><strong>Método de pago:</strong> {{ detalleVenta.metodoPago }}</p>

        <table>
          <thead>
            <tr>
              <th>Producto</th>
              <th>Cantidad</th>
              <th>Precio</th>
              <th>Subtotal</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let p of detalleVenta.productos">
              <td>{{ p.nombre }}</td>
              <td>{{ p.cantidad }}</td>
              <td>${{ formatPrecio(p.precio) }}</td>
              <td>${{ formatPrecio(p.cantidad * p.precio) }}</td>
            </tr>

            <tr>
              <td colspan="3"><strong>Total</strong></td>
              <td><strong>${{ calcularTotal(detalleVenta.productos) | number:'1.2-2' }}</strong></td>
            </tr>
          </tbody>
        </table>

        <button (click)="cerrarModal()" class="btn-cerrar">Cerrar</button>
      </div>
    </div>
  </div>
</ion-content>
