<ion-content [fullscreen]="true" class="proveedores-content">
  <ion-grid class="ion-padding">

    <!-- Filtros -->
    <ion-row class="ion-align-items-center filtros-row" no-wrap>
      <ion-col size="12" size-md="8">
        <ion-searchbar
          [(ngModel)]="busqueda"
          debounce="300"
          placeholder="Buscar proveedor..."
          class="searchbar-custom"
        ></ion-searchbar>
      </ion-col>

      <ion-col size="12" size-md="4" class="ion-text-end">
        <ion-button expand="block" color="success" size="small" (click)="nuevoProveedor()">
          <ion-icon slot="end" name="add-outline"></ion-icon>
          Nuevo Proveedor
        </ion-button>
      </ion-col>
    </ion-row>

    <!-- Lista de proveedores + formulario edición debajo de cada uno -->
    <ion-row class="ion-margin-top" style="gap:16px;">
      @for (prov of proveedoresFiltrados(); track prov.id) {
        <ion-col size="12" size-md="6">
          <ion-card class="proveedor-card card-elevated">
            <ion-item lines="none">
              <ion-icon slot="start" name="storefront-outline" class="icono-proveedor"></ion-icon>
              <ion-label>
                <h3 class="proveedor-nombre">{{ prov.nombre }} {{ prov.apellido }}</h3>
                <p class="proveedor-fecha">{{ prov.created_at | date:'mediumDate' }}</p>
                <div class="badges-row">
                  <ion-chip color="primary" class="chip-compact" *ngIf="prov.tipo_producto">
                    <ion-icon name="pricetag-outline"></ion-icon>
                    <ion-label>{{ prov.tipo_producto }}</ion-label>
                  </ion-chip>
                  <ion-chip color="medium" class="chip-compact" *ngIf="prov.telefono">
                    <ion-icon name="call-outline"></ion-icon>
                    <ion-label>{{ prov.telefono }}</ion-label>
                  </ion-chip>
                  <ion-chip color="medium" class="chip-compact" *ngIf="prov.email">
                    <ion-icon name="mail-outline"></ion-icon>
                    <ion-label>{{ prov.email }}</ion-label>
                  </ion-chip>
                </div>
              </ion-label>
              <ion-buttons slot="end" class="acciones-mini-col">
                <ion-button fill="clear" color="tertiary" size="small" (click)="editarProveedor(prov)">
                  <ion-icon name="create-outline" slot="icon-only"></ion-icon>
                </ion-button>
                <ion-button fill="clear" color="danger" size="small" (click)="eliminarProveedor(prov.id)">
                  <ion-icon name="trash-outline" slot="icon-only"></ion-icon>
                </ion-button>
              </ion-buttons>
            </ion-item>
          </ion-card>

          <!-- Formulario edición debajo del proveedor seleccionado -->
          @if (proveedorEditandoId === prov.id) {
            <ion-card class="form-edicion-card card-elevated">
              <ion-card-header>
                <ion-card-title>Editar Proveedor</ion-card-title>
              </ion-card-header>
              <ion-card-content>
                <form [formGroup]="editForm" (ngSubmit)="guardarCambios()">
                  <ion-item>
                    <ion-label position="floating">Nombre</ion-label>
                    <ion-input formControlName="nombre"></ion-input>
                  </ion-item>

                  <ion-item>
                    <ion-label position="floating">Apellido</ion-label>
                    <ion-input formControlName="apellido"></ion-input>
                  </ion-item>

                  <ion-item>
                    <ion-label position="floating">Edad</ion-label>
                    <ion-input formControlName="edad" type="number"></ion-input>
                  </ion-item>

                  <ion-item>
  <ion-label>Tipo de Producto</ion-label>
  <ion-select formControlName="tipo_producto" interface="popover" placeholder="Selecciona tipo">
    <ion-select-option *ngFor="let cat of categorias" [value]="cat.nombre">
      {{ cat.nombre }}
    </ion-select-option>
  </ion-select>
</ion-item>


                  <ion-item>
                    <ion-label position="floating">Teléfono</ion-label>
                    <ion-input formControlName="telefono"></ion-input>
                  </ion-item>

                  <ion-item>
                    <ion-label position="floating">Email</ion-label>
                    <ion-input formControlName="email" type="email"></ion-input>
                  </ion-item>

                  <ion-item>
                    <ion-label position="floating">Dirección</ion-label>
                    <ion-input formControlName="direccion"></ion-input>
                  </ion-item>

                  <ion-button expand="block" type="submit" [disabled]="editForm.invalid">Guardar Cambios</ion-button>
                  <ion-button expand="block" color="medium" type="button" (click)="cancelarEdicion()">Cancelar</ion-button>
                </form>
              </ion-card-content>
            </ion-card>
          }
        </ion-col>
      }
    </ion-row>

    @if (loading) {
      <ion-row>
        <ion-col class="ion-text-center">
          <ion-spinner name="crescent"></ion-spinner>
        </ion-col>
      </ion-row>
    }

    @if (!loading && proveedoresFiltrados().length === 0) {
      <ion-row>
        <ion-col class="ion-text-center">
          <p>No hay proveedores para mostrar.</p>
        </ion-col>
      </ion-row>
    }
  </ion-grid>
</ion-content>
