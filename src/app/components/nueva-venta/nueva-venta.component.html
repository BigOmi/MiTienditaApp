<!-- Encabezado local con botón Atrás -->
<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/home/ventas" text="Atrás"></ion-back-button>
      <ion-menu-button menu="main-menu" auto-hide="false"></ion-menu-button>
    </ion-buttons>
    <ion-title>Registrar Nueva Venta</ion-title>
  </ion-toolbar>
  
</ion-header>

<ion-content class="ion-padding">

  <!-- Barra de búsqueda general para agregar productos -->
  <ion-searchbar
    placeholder="Buscar producto para agregar..."
    [(ngModel)]="textoBusqueda"
    (ionInput)="filtrarProductosGlobal()"
    debounce="300"
    showClearButton="focus">
  </ion-searchbar>

  <!-- Lista de productos filtrados para agregar -->
  <ion-list *ngIf="productosFiltradosGlobal.length > 0 && textoBusqueda.trim().length > 0">
    <ion-item button detail lines="full" *ngFor="let producto of (productosFiltradosGlobal | slice:0:50); trackBy: trackByProductoId" (click)="agregarProducto(producto)">
      {{ producto.nombre }} (Stock: {{ producto.stock_actual }}) - ${{ producto.precio_venta }}
    </ion-item>
  </ion-list>

  <form [formGroup]="ventaForm" (ngSubmit)="onSubmit()">

    <!-- Método de pago -->
    <ion-item>
      <ion-label>Método de Pago</ion-label>
      <ion-select formControlName="metodo_pago" interface="popover">
        <ion-select-option value="efectivo">Efectivo</ion-select-option>
        <ion-select-option value="tarjeta">Tarjeta</ion-select-option>
        <ion-select-option value="transferencia">Transferencia</ion-select-option>
      </ion-select>
    </ion-item>

    <!-- Lista de productos agregados (detalles) -->
    <div formArrayName="detalles" class="detalles-venta" style="margin-top: 1rem;">
      <div *ngFor="let detalle of detalles.controls; let i = index; trackBy: trackByIndex" [formGroupName]="i" class="detalle-row">

        <ion-item lines="none">
          <ion-label>{{ obtenerNombreProducto(detalle.get('productoId')?.value) }}</ion-label>

          <ion-input
            type="number"
            min="1"
            formControlName="cantidad"
            (ionInput)="onCantidadInput(i)"
            style="width: 80px; text-align: center;">
          </ion-input>

          <ion-text slot="end" class="subtotal-text" style="margin-right: 10px;">
            ${{ subtotales[i] | number:'1.2-2' }}
          </ion-text>

          <ion-button fill="clear" color="danger" (click)="removeDetalle(i)" aria-label="Eliminar producto" slot="end">
            <ion-icon name="trash-outline"></ion-icon>
          </ion-button>
        </ion-item>

      </div>
    </div>

    <!-- Descuento total -->
    <ion-item lines="none" *ngIf="descuentoCalculado > 0" class="descuento-item" style="margin-top: 1rem;">
      <ion-label color="success"><strong>Descuento:</strong></ion-label>
      <ion-text color="success" slot="end">- ${{ descuentoCalculado | number:'1.2-2' }}</ion-text>
    </ion-item>

    <!-- Total con descuento -->
    <ion-item lines="none" class="total-item" style="margin-top: 0.5rem;">
      <ion-label><strong>Total a pagar:</strong></ion-label>
      <ion-text slot="end">${{ (calcularTotal() - descuentoCalculado) | number:'1.2-2' }}</ion-text>
    </ion-item>

    <ion-button
      expand="block"
      type="submit"
      [attr.disabled]="(ventaForm.invalid || detalles.length === 0) ? '' : null"
      style="margin-top: 1.5rem;">
      Registrar Venta
    </ion-button>

  </form>
</ion-content>

<!-- Botón flotante de regresar -->
<ion-fab slot="fixed" vertical="bottom" horizontal="start">
  <ion-fab-button color="medium" (click)="goBack()" aria-label="Volver atrás">
    <ion-icon name="arrow-back"></ion-icon>
  </ion-fab-button>
  <ion-fab-list side="top">
    <ion-fab-button color="primary" (click)="goBack()" aria-label="Volver">
      <ion-icon name="chevron-back"></ion-icon>
    </ion-fab-button>
  </ion-fab-list>
</ion-fab>
