<ion-header>
  <ion-toolbar>
    <ion-title>Registrar Nueva Venta</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">

  <!-- Barra de búsqueda general para agregar productos -->
  <ion-searchbar
    placeholder="Buscar producto para agregar..."
    [(ngModel)]="textoBusqueda"
    (ionInput)="filtrarProductosGlobal()"
    debounce="300"
    showClearButton="focus">
  </ion-searchbar>

  <!-- Lista de productos filtrados para agregar -->
  <ion-list *ngIf="productosFiltradosGlobal.length > 0 && textoBusqueda.trim().length > 0">
    <ion-item button detail lines="full" *ngFor="let producto of productosFiltradosGlobal" (click)="agregarProducto(producto)">
      {{ producto.nombre }} (Stock: {{ producto.stock_actual }}) - ${{ producto.precio_venta }}
    </ion-item>
  </ion-list>

  <form [formGroup]="ventaForm" (ngSubmit)="onSubmit()">

    <!-- Método de pago -->
    <ion-item>
      <ion-label>Método de Pago</ion-label>
      <ion-select formControlName="metodo_pago" interface="popover">
        <ion-select-option value="EFECTIVO">Efectivo</ion-select-option>
        <ion-select-option value="TARJETA">Tarjeta</ion-select-option>
        <ion-select-option value="TRANSFERENCIA">Transferencia</ion-select-option>
      </ion-select>
    </ion-item>

    <!-- Lista de productos agregados (detalles) -->
    <div formArrayName="detalles" class="detalles-venta" style="margin-top: 1rem;">
      <div *ngFor="let detalle of detalles.controls; let i = index" [formGroupName]="i" class="detalle-row">

        <ion-item lines="none">
          <ion-label>{{ obtenerNombreProducto(detalle.get('productoId')?.value) }}</ion-label>

          <ion-input
            type="number"
            min="1"
            formControlName="cantidad"
            (ionInput)="calcularDescuentoEnBack()"
            style="width: 80px; text-align: center;">
          </ion-input>

          <ion-text slot="end" class="subtotal-text" style="margin-right: 10px;">
            ${{ calcularSubtotal(detalle) | number:'1.2-2' }}
          </ion-text>

          <ion-button fill="clear" color="danger" (click)="removeDetalle(i)" aria-label="Eliminar producto" slot="end">
            <ion-icon name="trash-outline"></ion-icon>
          </ion-button>
        </ion-item>

      </div>
    </div>

    <!-- Descuento total -->
    <ion-item lines="none" *ngIf="descuentoCalculado > 0" class="descuento-item" style="margin-top: 1rem;">
      <ion-label color="success"><strong>Descuento:</strong></ion-label>
      <ion-text color="success" slot="end">- ${{ descuentoCalculado | number:'1.2-2' }}</ion-text>
    </ion-item>

    <!-- Total con descuento -->
    <ion-item lines="none" class="total-item" style="margin-top: 0.5rem;">
      <ion-label><strong>Total a pagar:</strong></ion-label>
      <ion-text slot="end">${{ (calcularTotal() - descuentoCalculado) | number:'1.2-2' }}</ion-text>
    </ion-item>

    <ion-button expand="block" type="submit" [disabled]="ventaForm.invalid || detalles.length === 0" style="margin-top: 1.5rem;">
      Registrar Venta
    </ion-button>

  </form>
</ion-content>
